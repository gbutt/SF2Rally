<apex:page showHeader="false" sidebar="false" standardController="Case" extensions="ctr_Case2Rally">
	<style type="text/css">
		.casetorally {
			padding: 20px;
		}
	</style>
	
	<div id="linkedArtifacts"></div>

	<div class="casetorally">
		<label for="alm_project">Project: </label>
		<select id="alm_project"></select>
		<br />

		<input id="btn_create_defect" type="button" value="Create Defect"></input>
		<input id="btn_create_userstory" type="button" value="Create User Story"></input>
	</div>


	<c:jquery />
	<script src="/soap/ajax/34.0/connection.js" type="text/javascript"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.1.3/mustache.js"></script>
	<apex:includeScript value="{!URLFOR($Resource.Case2Rally, '/js/almClient.js')}"></apex:includeScript>
	<apex:includeScript value="{!URLFOR($Resource.Case2Rally, '/js/sfdcClient.js')}"></apex:includeScript>

	<script type="text/javascript">	

		var sf = sfdcClient( {sessionId: '{!$Api.Session_ID}'} );

		var config = {
			almBaseUrl: 'https://rally1.rallydev.com/slm/webservice/v2.0/'
			,apiKey: '{!$Setup.Case2Rally__c.API_Key__c}'
		}
		var alm = almClient(config);

		// we do the actual work here
		j$(function(){
			j$('.casetorally').hide();
			// get case id
			var caseId = '{!Case.id}';
			var workspaceOid;

			var render = function(){
				var records = sf.getLinkRecords(caseId);
				var oids = [];
				j$.each(records, function(key, val) {
					oids.push(alm.parseOidFromUrl(val.ArtifactRef__c));
				});

				alm.fetchArtifacts(oids, workspaceOid, function(data){
					console.log(data);
					var template = j$('#rallyView').html();
					data.hasDefects = function(){return !!this.rallyDefects;};
					data.hasStories = function(){return !!this.rallyStories;};
					var html = Mustache.render(template, data);
					j$('#linkedArtifacts').html(html);
				});
				
			}

			// load user defaults - then load projects
			var bindCreateForm = function(userDefaults) {
				var bindProjects = function(projects) {
					j$('#alm_project').find('option').remove();
					j$.each(projects, function(key, value) {
					     var option = j$('#alm_project')
					         .append(j$("<option></option>")
					         .attr("value",value.oid)
					         .text(value.name));
					     if (userDefaults.projectOid === value.oid){
					     	j$('#alm_project').val(userDefaults.projectOid);
					     }
					});
					j$('#alm_project').trigger('bound');
				};

				alm.getAlmProjects(workspaceOid, bindProjects);
				
			}

			var createArtifact = function(typeName) {
				// get defect mapping
				var defectMap = sf.defectMap;

				// get merge fields from case
				var caseFieldsToQuery = [];
				j$.each(defectMap, function(key, value) {
					if (!value.literalValue	) {
						caseFieldsToQuery.push(value.fldValue);
					}
				});
				var caseObj = sf.fetchCaseValues(caseId,caseFieldsToQuery);

				// create rally defect object
				var rallyArtifact = {};
				j$.each(defectMap, function(key, value) {
					rallyArtifact[key] = value.literalValue || caseObj[value.fldValue];
				});

				// call wsapi
				var projectOid = j$('#alm_project').val();
				// var typeName = j$('#alm_artifact_type').val();
				alm.createArtifact(projectOid, typeName, rallyArtifact, function(response) {
					sf.createLinkRecord({Case__c : caseId, artifactRef__c: response.CreateResult.Object._ref});
					// rebind linkedArtifacts
				});
			}
			j$('#btn_create_defect').on('click', function(){createArtifact('defect')});
			j$('#btn_create_userstory').on('click', function(){createArtifact('hierarchicalrequirement')});

			// show form
			j$('#alm_project').on('bound', function() {
				j$('.casetorally').show();
			});

			alm.getAlmWorkspaceByName(sf.workspaceName, function(workspace) {
				workspaceOid = workspace.ObjectID;
				alm.getUserDefaults(bindCreateForm);
				render();
			});
		});
	</script>

	<script id="rallyView" type="x-tmpl-mustache">
		{{#hasStories}}
			<h2>Rally Stories:</h2>
			<table>
				<tr>
					<th>Name</th>
					<th>Owner</th>
					<th>Schedule State</th>
					<th>Discussion</th>
					<th>Attachments</th>
				</tr>
			{{#rallyStories}}
				<tr>
					<td><a href="{{_ref}}">{{Name}}</a></td>
					<td>{{Owner.DisplayName}}</td>
					<td>{{ScheduleState}}</td>
					<td>{{Discussion.Count}}</td>
					<td>{{Attachments.Count}}</td>
				</tr>
			{{/rallyStories}}
			</table>
		{{/hasStories}}
		{{#hasDefects}}
			<h2>Rally Defects:</h2>
			<table>
				<tr>
					<th>Name</th>
					<th>Owner</th>
					<th>Schedule State</th>
					<th>State</th>
					<th>Discussion</th>
					<th>Attachments</th>
				</tr>
			{{#rallyDefects}}
				<tr>
					<td><a href="{{_ref}}">{{Name}}</a></td>
					<td>{{Owner.DisplayName}}</td>
					<td>{{ScheduleState}}</td>
					<td>{{State}}</td>
					<td>{{Discussion.Count}}</td>
					<td>{{Attachments.Count}}</td>
				</tr>
			{{/rallyDefects}}
			</table>
		{{/hasDefects}}
	</script>


</apex:page>