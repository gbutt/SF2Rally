/*! case2rally 2015-10-08 */
/*! visit https://github.com/gbutt/RSM for more info. */

!function(){angular.module("c2rSetupApp",["ngRoute","app.config","artifactMapperCtrl"]).config(["$routeProvider","appConfig",function(a,b){a.when("/artifactMapper",{templateUrl:b.resourceUrl+"/partials/c2rSetup/artifact-mapper.html",controller:"ArtifactMapperCtrl"}).otherwise({redirectTo:"/artifactMapper"})}])}(),function(){angular.module("caseToRallyApp",["ngRoute","caseToRallyControllers","app.config"]).config(["$routeProvider","appConfig",function(a,b){a.when("/artifacts",{templateUrl:b.resourceUrl+"/partials/caseToRally/case-to-rally.html",controller:"CaseToRallyCtrl"}).otherwise({redirectTo:"/artifacts"})}]).directive("c2rCreateArtifact",["appConfig",function(a){return{restrict:"E",templateUrl:a.resourceUrl+"/partials/caseToRally/create-artifact.html"}}]).directive("c2rListArtifacts",["appConfig",function(a){return{restrict:"E",templateUrl:a.resourceUrl+"/partials/caseToRally/list-artifacts.html"}}])}(),function(){var a=function(a){var b={},d=["COLLECTION"],e=["FoundInBuild","Severity","Priority","Environment","Description","Name","Package","Owner"];return a.Attributes.forEach(function(a){!a.ReadOnly&&-1===d.indexOf(a.AttributeType)&&(a.Custom||e.indexOf(a.ElementName)>-1)&&(b[a.ElementName]=a)}),c(b)},b=function(a){return function(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}},c=function(a){var c=[],d=[];return angular.forEach(a,function(a){a.Custom?d.push(a):c.push(a)}),c.sort(b("Name")).concat(d.sort(b("Name")))},d=function(a){return a.replace("_"," ").toLowerCase().replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()})},e=function(b,c,e){var f=[],g=a(b);return g.forEach(function(a){var b=a.ElementName,g=Array.isArray(a.AllowedValues)&&a.AllowedValues.length>0?a.AllowedValues:[],h=d(a.AttributeType),i=c[b]||{},j=[];a.Required||j.push({name:"None",label:""}),j.push({name:"Default",label:"<Default Value>"}),j=j.concat(e);var k={rallyFieldCode:b,caseField:{value:i.fldValue||j[0].name,options:j},defaultField:{value:i.literalValue||(g.length>0?g[0].StringValue:""),allowedValues:g,type:function(){return this.allowedValues.length>0?"select":"input"}},rallyFieldName:a.Name,rallyFieldType:h};k.defaultField.cachedValue=k.defaultField.value,k.defaultField.disabled=function(){return"Default"!==k.caseField.value},f.push(k)}),f};angular.module("artifactMapperCtrl",["sfServices","almServices","app.config"]).controller("ArtifactMapperCtrl",["$scope","sfClientService","almClientService","appConfig","$q",function(a,c,d,f,g){var h=function(){var a=d.getInstance(),b=c.getInstance();return g.all({almClient:a,sfClient:b})},i=function(c,d){var h=function(){angular.forEach(a.rows,function(a){a.removeWatch&&a.removeWatch()})},i=function(){angular.forEach(a.rows,function(b){var c=a.$watch(function(){return b.caseField.value},function(a,c){"Default"===c&&"Default"!==a?(b.defaultField.cachedValue=b.defaultField.value,b.defaultField.value=""):"Default"!==c&&"Default"===a&&(b.defaultField.value=b.defaultField.cachedValue)});b.removeWatch=c})},j=function(j){g.all({typeDefSchema:d.fetchTypeDefSchemaByName(a.artifactType),caseFields:c.fetchCaseFields()}).then(function(c){var d=c.typeDefSchema,g=c.caseFields,h="Defect"==a.artifactType?f.setupRecord.Defect_Field_Map__c:f.setupRecord.Story_Field_Map__c,i=JSON.parse(h||"{}");return e(d,i,g.sort(b("label")))}).then(function(b){h(),a.rows=b,i()})};a.saveSettings=function(){},a.$watch("artifactType",j),a.artifactType="Defect"};h().then(function(a){var b=a.sfClient,c=a.almClient;i(b,c)})}])}(),function(){angular.module("caseToRallyControllers",["sfServices","almServices","app.config"]).controller("CaseToRallyCtrl",["$scope","sfClientService","almClientService","appConfig","$q",function(a,b,c,d,e){var f=function(){var a=c.getInstance(),d=b.getInstance();return e.all({almClient:a,sfClient:d})},g=function(b,c){a.removeLink=function(c,d){if(c){if("defect"===d){var e=a.defects.indexOf(c);a.defects.splice(e,1)}else if("userStory"===d){var e=a.userStories.indexOf(c);a.userStories.splice(e,1)}b.deleteLinkRecord(c.LinkId)}},a.refresh=function(){var e={};b.getLinkRecords(d.caseId).then(function(a){var b=[];return angular.forEach(a,function(a){var d=c.parseOidFromUrl(a.ArtifactRef__c);e[d]=a.Id,b.push(d)}),c.fetchArtifacts(b)}).then(function(a){return angular.forEach(a.rallyDefects.concat(a.rallyStories),function(a){a.LinkId=e[a.ObjectID]}),a}).then(function(b){a.defects=b.rallyDefects,a.userStories=b.rallyStories})},a.refresh()},h=function(b,c){var f=function(){var a=e.defer();return e.all({userDefaults:c.fetchUserDefaults(),projects:c.fetchProjects()}).then(function(b){var c=b.userDefaults,d=b.projects,e=void 0;1===d.filter(function(a){return a.ObjectID===c.projectOid}).length?e=c.projectOid:d.length>0&&(e=d[0].ObjectID),a.resolve({projects:d,selectedProjectOid:e})}),a.promise};a.createArtifact=function(e){var f=JSON.parse(d.setupRecord[e+"_Field_Map__c"]||"{}"),g=[];angular.forEach(f,function(a){a.literalValue||g.push(a.fldValue)}),b.fetchCaseValues(d.caseId,g).then(function(b){var d={};angular.forEach(f,function(a,c){d[c]=a.literalValue||b[a.fldValue]});var g="Defect"==e?"Defect":"HierarchicalRequirement";return c.createArtifact(a.selectedProjectOid,g,d)}).then(function(a){var c={Case__c:d.caseId,artifactRef__c:a.data.CreateResult.Object._ref};return b.createLinkRecord(c)}).then(function(b){a.refresh()})},f().then(function(b){a.projects=b.projects,a.selectedProjectOid=b.selectedProjectOid})};f().then(function(b){var c=b.sfClient,e=b.almClient;a.RallyUrl=d.setupRecord.rallyUrl__c,g(c,e),h(c,e)})}])}(),function(){angular.module("almServices",[]).factory("almClientService",["sfClientService","$http","appConfig","$q",function(b,c,d,e){var f=function(){return b.getInstance()},g=function(){var b=e.defer();return f().then(function(a){return a.fetchSetupRecord()}).then(function(f){d.setupRecord=f;var g={rallyUrl:d.setupRecord.rallyUrl__c,apiKey:d.setupRecord.apiKey__c,wsapiVersion:"v2.0",workspaceName:d.setupRecord.Name};b.resolve(a(g,c,angular,e))}),b.promise},h=void 0;return{getInstance:function(){var a=e.defer();return h?a.resolve(h):g().then(function(b){h=b,a.resolve(h)}),a.promise}}}]);var a=function(a,b,c,d){var e=a.rallyUrl,f=a.apiKey;wsapiVersion=a.wsapiVersion,wsapiBaseUrl=e+"/slm/webservice/"+wsapiVersion+"/",schemaBaseUrl=e+"/slm/schema/"+wsapiVersion+"/",workspace={Name:a.workspaceName},b.defaults.headers.common={zsessionid:f},b.defaults.headers.post={"Content-Type":"application/json"};var g={};g.parseOidFromUrl=function(a){return a.substring(a.lastIndexOf("/")+1)};var h=function(a,c,d){var e="http"===a.substring(0,4)?a:wsapiBaseUrl+a;return b.post(e,c,d)},i=function(a,d){var e="http"===a.substring(0,4)?a:wsapiBaseUrl+a,f={cache:!0};return c.extend(f,d),b.get(e,f)},j=function(a){for(var b="",c=a.length,d=0;c>d;d++){var e=a[d],f="(ObjectID = "+e+")";d>0&&(f="("+b+" OR "+f+")"),b=f}return b},k=function(){var a="workspace",b={workspace:"null",query:'(Name = "'+workspace.Name+'")',fetch:"ObjectID,SchemaVersion,Name"};return i(a,{params:b}).then(function(a){var b=a.data.QueryResult.Results;if(1!==b.length)throw"Bad workspace name";return workspace=b[0],workspace})};return g.fetchArtifacts=function(a){return k().then(function(b){var c="artifact",d={types:"Defect,HierarchicalRequirement",fetch:"Name,Owner,DisplayName,Project,State,ScheduleState,Discussion,Attachments,ObjectID",workspace:"/workspace/"+b.ObjectID,pagesize:200,query:j(a)};return i(c,{params:d,cache:!1})}).then(function(a){for(var b={rallyDefects:[],rallyStories:[]},c=a.data.QueryResult.Results.length-1;c>=0;c--){var d=a.data.QueryResult.Results[c];"Defect"===d._type?b.rallyDefects.push(d):b.rallyStories.push(d)}return b})},g.fetchUserDefaults=function(){return k().then(function(a){var b="user:current",c={workspace:"/workspace/"+a.ObjectID};return i(b,{params:c})}).then(function(a){var b=a.data.User.UserProfile._ref,c={fetch:"ObjectID,DefaultProject,DefaultWorkspace"};return i(b,{params:c})}).then(function(a){var b=(a.data.UserProfile.DefaultProject||{}).ObjectID,c=(a.data.UserProfile.DefaultWorkspace||{}).ObjectID;return{projectOid:b,workspaceOid:c}})},g.fetchProjects=function(){var a=d.defer();return k().then(function(a){var b={order:"Name",fetch:"ObjectID,Name",workspace:"/workspace/"+a.ObjectID,pageSize:200};return i("project",{params:b})}).then(function(b){var d=b.data.QueryResult.TotalResultCount,e=[],f=function(b){c.forEach(b.data.QueryResult.Results,function(a){e.push(a)}),e.length===d&&a.resolve(e)};if(f(b),d>200)for(var g=Math.floor(d/200),h=g;h>0;h--){var j={start:200*h+1};c.extend(j,params),i("project",{params:j}).then(f)}}),a.promise},g.fetchTypeDefSchemaByName=function(a){var b=k().then(function(a){return i(schemaBaseUrl+"workspace/"+a.ObjectID+"/"+a.SchemaVersion)}).then(function(b){return b.data.QueryResult.Results.filter(function(b){return b.ElementName===a})[0]});return b},g.createArtifact=function(a,b,c){var d=b+"/create",e={};return c.Project="/project/"+a,e[b]=c,h(d,e)},g}}(),function(){angular.module("sfServices",["ngForce"]).factory("sfClientService",["appConfig","$q","vfr",function(b,c,d){var e=a(d);return{getInstance:function(){var a=c.defer();return a.resolve(e),a.promise}}}]);var a=function(a){var b={};return b.fetchSetupRecord=function(){var b="SELECT Id, Name, rallyUrl__c, Defect_Field_Map__c, Story_Field_Map__c, apiKey__c FROM Case2Rally_Setup__c LIMIT 1";return a.query(b).then(function(a){return a.records[0]})},b.fetchCaseFields=function(){return a.describe("Case").then(function(a){return a.fields.filter(function(a){return!a.referenceTo})})},b.fetchCaseValues=function(b,c){var d="SELECT "+c.join(", ")+" FROM Case WHERE Id = '"+b+"'";return a.query(d).then(function(a){return a.records})},b.createLinkRecord=function(b){return a.create("Case2RallyArtifact__c",b)},b.getLinkRecords=function(b){var c="SELECT Id, ArtifactRef__c FROM Case2RallyArtifact__c WHERE Case__c = '"+b+"'";return a.query(c).then(function(a){return a.records})},b.deleteLinkRecord=function(b){return a.del("Case2RallyArtifact__c",b)},b}}();
//# sourceMappingURL=caseToRallyNg.min.js.map